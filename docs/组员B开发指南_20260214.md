# 易宿酒店预订平台 - 组员B快速上手指南

> 最后更新：2026-02-14

## 📋 项目概览

### 技术栈
| 层级 | 技术 | 说明 |
|-----|------|-----|
| 前端 | React 18 + TypeScript + Ant Design + Vite | 管理端 |
| 后端 | Node.js + Express + TypeScript | RESTful API |
| 数据存储 | JSON文件 | `/server/src/data/` 目录 |

### 项目结构
```
Trip/
├── server/          # 后端API服务
│   ├── src/
│   │   ├── controllers/  # 控制器层
│   │   ├── services/     # 业务逻辑层
│   │   ├── routes/       # 路由定义
│   │   ├── middleware/   # 中间件（认证、错误处理）
│   │   └── data/         # JSON数据存储
│   └── .env           # 环境变量（端口3000）
├── admin/           # 管理端（PC）
│   ├── src/
│   │   ├── pages/       # 页面组件
│   │   ├── components/  # 公共组件
│   │   ├── store/       # 状态管理
│   │   ├── services/     # API服务
│   │   └── router.tsx    # 路由配置
│   └── .env           # Vite环境变量
├── shared/          # 前后端共享类型定义
│   └── types/        # TypeScript类型定义
├── mini-app/        # 移动端（待开发）
```

---

## 🚀 快速启动

### 1. 安装依赖
```bash
# 在项目根目录执行
pnpm install
```

### 2. 启动服务
```bash
# 同时启动后端和前端（推荐）
pnpm run dev

# 或者分别启动
# 终端1：后端服务
cd server && npm run dev

# 终端2：管理端（Admin）
cd admin && npm run dev
```

### 3. 访问地址
| 服务 | 地址 | 账号 |
|-----|------|-----|
| 后端API | http://localhost:3000 | - |
| 管理端 | http://localhost:5173 | - |

### 4. 测试账号
| 角色 | 用户名 | 密码 | 权限 |
|-----|--------|------|-----|
| 管理员 | admin | admin123 | 查看所有酒店、审核、删除 |
| 商户 | hoteladmin | admin123 | 只能操作自己创建的酒店 |

---

## 👥 角色权限设计

### 权限矩阵
| 功能 | 管理员 (admin) | 商户 (hotel_admin) |
|-----|----------------------|---------------------------|
| 查看酒店列表 | ✅ 所有酒店 | ✅ 仅自己创建的 |
| 创建酒店 | ✅ 可以 | ✅ 可以 |
| 编辑酒店 | ✅ 所有酒店 | ✅ 仅自己创建的 |
| 删除酒店 | ✅ 可以 | ❌ 不可见按钮 |
| 审核酒店 | ✅ 可以 | ❌ 不可访问审核页 |
| 上线/下线 | ✅ 可以 | ❌ 不可 |

### 实现方式
```typescript
// 前端：根据角色过滤
const params = {
  includeAll: true,
  ...(user?.role === UserRole.HOTEL_ADMIN && { createdBy: user.id })
};

// 后端：createdBy过滤
if (params.createdBy) {
  hotels = hotels.filter(h => h.createdBy === params.createdBy);
}
```

---

## 📊 已实现功能

### 后端API (server/src/)

#### 认证相关
- ✅ `POST /api/auth/login` - 用户登录
- ✅ JWT中间件 - Token验证

#### 酒店管理 (controllers/hotels.ts)
- ✅ `GET /api/hotels` - 获取酒店列表（支持createdBy过滤）
- ✅ `GET /api/hotels/:id` - 获取单个酒店
- ✅ `POST /api/hotels` - 创建酒店
- ✅ `PUT /api/hotels/:id` - 更新酒店
- ✅ `DELETE /api/hotels/:id` - 删除酒店

#### 审核相关 (services/hotels.ts)
- ✅ `PUT /api/hotels/:id/audit` - 审核酒店（approve/reject）
  - 保存拒绝原因
  - 通过后移除rejectionReason
- ✅ `PUT /api/hotels/:id/status` - 更新酒店状态（online/offline）
- ✅ 编辑已审核通过的酒店自动重置为pending

### 管理端 (admin/src/)

#### 页面路由 (router.tsx)
| 路由 | 组件 | 权限要求 |
|-----|------|----------|
| `/login` | Login | 公开 |
| `/hotels/edit` | HotelEdit | 需要登录 |
| `/hotels/audit` | AuditList | 需要登录 + admin角色 |

#### HotelEdit页面 (pages/HotelEdit/)
- ✅ 酒店列表展示（根据角色过滤）
- ✅ 创建/编辑酒店表单
- ✅ 经纬度独立输入框
- ✅ 删除按钮（仅admin可见）
- ✅ 状态标签显示

#### AuditList页面 (pages/AuditList/)
- ✅ 多标签页（pending/approved/rejected/offline）
- ✅ 审核功能（通过/拒绝+原因）
- ✅ 上线/下线功能
- ✅ 查看拒绝原因Modal

---

## 🔑 核心文件说明

### 类型定义 (shared/types/)

#### hotel.ts
```typescript
// 酒店状态枚举
enum HotelStatus {
  PENDING = 'pending',      // 待审核
  APPROVED = 'approved',    // 已通过
  REJECTED = 'rejected',    // 已拒绝
  OFFLINE = 'offline'       // 已下线
}

// 酒店接口
interface Hotel {
  id: string;
  name: string;
  address: string;
  // ...
  status: HotelStatus;
  rejectionReason?: string;  // ✅ 拒绝原因
  createdBy: string;          // ✅ 创建者ID
  // ...
}

// 查询参数
interface HotelQueryParams {
  // ...
  status?: string;
  includeAll?: boolean;       // ✅ 包含所有状态
  createdBy?: string;          // ✅ 创建者筛选
  // ...
}
```

#### user.ts
```typescript
enum UserRole {
  ADMIN = 'admin',              // 管理员
  HOTEL_ADMIN = 'hotel_admin', // 商户
  USER = 'user'                 // 普通用户
}
```

### 业务逻辑 (server/src/services/)

#### hotels.ts - 关键函数
```typescript
// 获取酒店列表（支持createdBy过滤）
getList: async (params: HotelQueryParams) => {
  // ...
  if (params.createdBy) {
    hotels = hotels.filter(h => h.createdBy === params.createdBy);
  }
}

// 审核酒店（保存拒绝原因）
audit: async (id, action, reason?) => {
  if (action === 'approve') {
    hotel.status = HotelStatus.APPROVED;
    delete hotel.rejectionReason;
  } else {
    hotel.status = HotelStatus.REJECTED;
    hotel.rejectionReason = reason;
  }
}

// 更新酒店（编辑后重置状态）
update: async (id, data) => {
  // 如果是approved/rejected状态，编辑后重置为pending
  if (hotel.status === HotelStatus.APPROVED ||
      hotel.status === HotelStatus.REJECTED) {
    hotel.status = HotelStatus.PENDING;
    delete hotel.rejectionReason;
  }
}
```

---

## 🔄 业务流程

### 酒店创建到上线流程
```
1. 商户登录
   ↓
2. 创建酒店（HotelEdit页面）
   - 状态: pending
   - createdBy: user.id
   ↓
3. 管理员审核（AuditList页面）
   ├─ 通过 → status: approved（移动端可见）
   └─ 拒绝 → status: rejected + rejectionReason
   ↓
4. [approved] 商户编辑酒店
   - 状态自动重置为: pending（重新审核）
   ↓
5. 管理员再次审核
   ↓
6. 上线（移动端可预订）
```

### 数据流转
```
前端表单数据
  → 数据转换（handleSubmit）
    → POST /api/hotels
      → hotelService.create()
        → hotels.json写入
          → 返回Hotel对象
            → 前端更新列表
```

---

## 📝 待开发功能

### 高优级
- [ ] 用户注册功能
- [ ] 图片上传（当前使用URL字符串）
- [ ] 房型管理CRUD

### 中优级
- [ ] 审核历史记录
- [ ] 酒店统计报表
- [ ] 导出Excel功能

### 移动端 (mini-app/)
- [ ] 首页展示酒店列表
- [ ] 酒店详情页
- [ ] 在线预订功能

---

## 🐛 常见问题

### CORS错误
**问题**：Access to XMLHttpRequest blocked by CORS policy
**原因**：前端端口与CORS_ORIGINS不匹配
**解决**：检查 `server/.env` 的 `CORS_ORIGINS` 配置

### UserRole未定义
**问题**：ReferenceError: UserRole is not defined
**原因**：使用了 `import type { UserRole }`（仅类型导入）
**解决**：改为 `import { UserRole }`（运行时需要访问枚举值）

### 端口3000被占用
**Windows解决**：
```bash
# 查找占用进程
netstat -ano | findstr :3000

# 终止进程
taskkill /F /PID <进程ID>
```

---

## 🔗 开发规范

### Git提交
```bash
feat: 新功能
fix: 修复bug
refactor: 重构（不改变功能）
docs: 文档更新
```

### 代码规范
- 使用TypeScript严格模式
- 组件使用函数式组件
- API调用统一使用 `@/services/api`
- 状态管理使用Zustand

### 命名规范
- 组件：PascalCase（HotelEdit）
- 函数：camelCase（fetchHotels）
- 类型：PascalCase（Hotel, UserRole）
- 常量：UPPER_SNAKE_HOTEL_ID

---

## 📞 重要链接

| 文档 | 路径 |
|-----|------|
| React文档 | https://react.dev/ |
| Ant Design | https://ant.design/ |
| TypeScript | https://www.typescriptlang.org/ |
| Express.js | https://expressjs.com/ |

---

## 💬 给组员B的建议

### 第一周任务
1. ✅ 熟悉项目结构（30分钟）
2. ✅ 本地启动项目（15分钟）
3. ✅ 测试不同角色的权限（30分钟）
4. 📝 阅读shared/types/下的类型定义（1小时）

### 第二周任务
1. 实现用户注册功能
2. 添加图片上传（可考虑七牛云/阿里云OSS）
3. 实现房型管理CRUD

### 开发时注意
- ⚠️ 后端修改需重启`npm run dev`
- ⚠️ 前端修改Vite会自动热更新
- ⚠️ 修改类型定义后需重新启动前后端
- ⚠️ 查看`server/src/data/hotels.json`了解数据结构

---

**最后更新**: 2026-02-14
**维护者**: 组员A
